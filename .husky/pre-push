#!/bin/sh

# =============================================================================
# OpenFlow Pre-Push Validation Suite
# =============================================================================
#
# Runs comprehensive checks before pushing to remote.
# All phases must pass for the push to succeed.
#
# Bypass: SKIP_VALIDATION=1 git push
#
# Phases:
#   1. Generation   - TypeScript types, TanStack Router routes
#   2. Type Check   - Full TypeScript compilation
#   3. Linting      - Biome lint and format
#   4. Validation   - Blocking validators (architecture, types, etc.)
#   5. Tests        - Unit tests (e2e excluded)
#   6. Rust         - cargo check, test, clippy
#   7. Warnings     - Non-blocking validators (routes, storybook, etc.)
#
# Note: Blocking validators must pass. Non-blocking show warnings only.
# =============================================================================

# -----------------------------------------------------------------------------
# Bypass check
# -----------------------------------------------------------------------------
if [ "$SKIP_VALIDATION" = "1" ]; then
  echo "⚠️  SKIP_VALIDATION=1 - Bypassing all pre-push validation"
  echo "   Use with caution! This may push broken code."
  exit 0
fi

echo ""
echo "╔══════════════════════════════════════════════════════════════════════════╗"
echo "║                    OpenFlow Pre-Push Validation Suite                     ║"
echo "╚══════════════════════════════════════════════════════════════════════════╝"
echo ""

# Track overall timing
START_TIME=$(date +%s)

# Helper function for phase headers
print_phase() {
  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "  Phase $1: $2"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

# Helper function for success messages
print_success() {
  echo "  ✓ $1"
}

# Helper function for failure messages
print_failure() {
  echo "  ✗ $1"
}

# =============================================================================
# Phase 1: Generation
# =============================================================================
print_phase "1" "Generation (types, routes)"

echo "  → Generating TypeScript types from Rust..."
pnpm generate:types
if [ $? -ne 0 ]; then
  print_failure "Type generation failed"
  exit 1
fi
print_success "TypeScript types generated"

echo "  → Generating TanStack Router routes..."
pnpm generate:routes
if [ $? -ne 0 ]; then
  print_failure "Route generation failed"
  exit 1
fi
print_success "Routes generated"

# =============================================================================
# Phase 2: Type Checking
# =============================================================================
print_phase "2" "Type Checking"

echo "  → Running TypeScript compiler..."
pnpm typecheck
if [ $? -ne 0 ]; then
  print_failure "TypeScript type check failed"
  exit 1
fi
print_success "TypeScript compilation successful"

# =============================================================================
# Phase 3: Linting
# =============================================================================
print_phase "3" "Linting"

echo "  → Running Biome lint..."
pnpm lint
if [ $? -ne 0 ]; then
  print_failure "Biome lint failed"
  exit 1
fi
print_success "Biome lint passed"

# =============================================================================
# Phase 4: Blocking Validators
# =============================================================================
print_phase "4" "Blocking Validators"

echo "  Running blocking validators..."
echo "  Architecture, type safety, and core pattern validators must pass."
echo ""

# Run blocking validators via the orchestrator
# Exit codes: 0 = pass, 1 = error (fail), 2 = warnings (pass with warnings)
# Use || true pattern to prevent shell from exiting on non-zero, then capture exit code
VALIDATION_EXIT=0
pnpm validate:blocking || VALIDATION_EXIT=$?

if [ $VALIDATION_EXIT -eq 1 ]; then
  echo ""
  print_failure "Blocking validation failed!"
  echo ""
  echo "  Fix the above errors before pushing."
  echo "  Run 'pnpm validate:blocking' for detailed output."
  exit 1
elif [ $VALIDATION_EXIT -eq 2 ]; then
  echo ""
  echo "  ⚠ Blocking validators passed with warnings (see above)"
else
  print_success "Blocking validators passed"
fi

# =============================================================================
# Phase 5: Unit Tests
# =============================================================================
print_phase "5" "Unit Tests"

echo "  → Running Vitest unit tests..."
echo "    (e2e tests excluded - run 'pnpm test:e2e' with app running)"
pnpm test --passWithNoTests
if [ $? -ne 0 ]; then
  print_failure "Unit tests failed"
  exit 1
fi
print_success "Unit tests passed"

# =============================================================================
# Phase 6: Rust Validation
# =============================================================================
print_phase "6" "Rust Validation"

# Create dist directory if it doesn't exist (required by Tauri config)
mkdir -p dist

echo "  → Running cargo check..."
(cd src-tauri && cargo check)
if [ $? -ne 0 ]; then
  print_failure "Cargo check failed"
  exit 1
fi
print_success "Cargo check passed"

echo "  → Running cargo test..."
(cd src-tauri && cargo test)
if [ $? -ne 0 ]; then
  print_failure "Cargo tests failed"
  exit 1
fi
print_success "Cargo tests passed"

echo "  → Running cargo clippy..."
(cd src-tauri && cargo clippy -- -D warnings)
if [ $? -ne 0 ]; then
  print_failure "Cargo clippy failed"
  exit 1
fi
print_success "Cargo clippy passed"

# =============================================================================
# Phase 7: Non-Blocking Validators (Warnings Only)
# =============================================================================
print_phase "7" "Non-Blocking Validators (Warnings)"

echo "  Running non-blocking validators..."
echo "  These show warnings but do not block the push."
echo ""

# Run non-blocking validators - don't fail on exit code
pnpm validate:all --non-blocking || true
print_success "Non-blocking validators checked (see warnings above)"

# =============================================================================
# Summary
# =============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "╔══════════════════════════════════════════════════════════════════════════╗"
echo "║                      Pre-Push Validation Complete!                        ║"
echo "╠══════════════════════════════════════════════════════════════════════════╣"
printf "║  Total time: %3ds                                                         ║\n" $DURATION
echo "╚══════════════════════════════════════════════════════════════════════════╝"
echo ""

exit 0
